<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>TL Hub</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="assets/images/icon/header-logo.png">

  <!--Google font-->
  <link
    href="https://fonts.googleapis.com/css?family=Nunito:300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Work+Sans:400,500,600,700,800,900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Vampiro+One&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Dancing+Script&display=swap" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css?family=Pacifico&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Bangers&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
    integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
    crossorigin="anonymous"></script>


  <!-- Google Map -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjeJEPREBQFvAIqDSZliF0WjQrCld-Mh0"></script>


  <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    /* .container {
      max-width: 630px;
      margin: auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    } */

    .button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      margin: 10px 0;
      cursor: pointer;
      border-radius: 5px;
    }

    .button:hover {
      background-color: #0056b3;
    }

    .input-group {
      margin-bottom: 10px;
    }

    .input-group label {
      display: block;
      font-weight: bold;
    }

    .input-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
  </style>
</head>

<body>

  <script>
    // Web3 Initialization
    let web3;
    let contract;
    const contractAddress = "0x372aB8bB444e513bD63c74547d00179fC3Fb432d"; // "0xba5084D99F755b7A2F0A7e6D196e0e60156043CE"; // Replace with your contract address
    const abi = [{ "inputs": [], "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "string", "name": "uniqId", "type": "string" }, { "indexed": false, "internalType": "string", "name": "newHashes", "type": "string" }], "name": "IPFSHashesUpdated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "uint256", "name": "id", "type": "uint256" }, { "indexed": true, "internalType": "string", "name": "uniqId", "type": "string" }], "name": "NFTCreated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "string", "name": "uniqId", "type": "string" }, { "indexed": false, "internalType": "uint256", "name": "newPrice", "type": "uint256" }], "name": "NFTPriceUpdated", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "uint256", "name": "id", "type": "uint256" }, { "indexed": true, "internalType": "address", "name": "buyer", "type": "address" }], "name": "NFTPurchased", "type": "event" }, { "inputs": [], "name": "admin", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "string", "name": "uniqId", "type": "string" }, { "internalType": "uint256", "name": "price", "type": "uint256" }, { "internalType": "string[]", "name": "initialHashes", "type": "string[]" }], "name": "createNFT", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "nftId", "type": "uint256" }, { "internalType": "address", "name": "user", "type": "address" }], "name": "isBuyer", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "nftCounter", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "name": "nfts", "outputs": [{ "internalType": "uint256", "name": "id", "type": "uint256" }, { "internalType": "uint256", "name": "price", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "string", "name": "uniqId", "type": "string" }], "name": "purchaseNFT", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [{ "internalType": "string", "name": "", "type": "string" }], "name": "uniqIdToNFT", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "string", "name": "uniqId", "type": "string" }, { "internalType": "string", "name": "newHashes", "type": "string" }], "name": "updateIPFSHashes", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "string", "name": "uniqId", "type": "string" }, { "internalType": "uint256", "name": "newPrice", "type": "uint256" }], "name": "updateNFTPrice", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "string", "name": "uniqId", "type": "string" }], "name": "viewNFT", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }, { "internalType": "uint256", "name": "", "type": "uint256" }, { "internalType": "string[]", "name": "", "type": "string[]" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "withdrawFunds", "outputs": [], "stateMutability": "nonpayable", "type": "function" }]; // Replace with your contract ABI

    // Connect Wallet
    async function connectWallet() {
      if (window.ethereum) {
        try {
          // Request account access
          await window.ethereum.request({ method: "eth_requestAccounts" });
          web3 = new Web3(window.ethereum);

          // Get user's wallet address
          const accounts = await web3.eth.getAccounts();
          const walletAddress = accounts[0];
          document.getElementById("walletAddress").innerText = `Wallet Connected: ${walletAddress}`;

          // Initialize contract instance
          contract = new web3.eth.Contract(abi, contractAddress);
        } catch (error) {
          console.error("User denied account access:", error);
        }
      } else {
        alert("MetaMask is not installed. Please install MetaMask to use this feature.");
      }
    }

    // Purchase NFT
    async function purchaseNFT() {
      if (!web3) {
        alert("Please connect your wallet first.");
        return;
      }

      const uniqId = document.getElementById("uniqId").value;
      const priceInEth = "0.0001"; //document.getElementById("price").value;

      if (!uniqId || !priceInEth) {
        alert("Please enter both Unique ID and Price.");
        return;
      }

      try {
        const accounts = await web3.eth.getAccounts();
        const buyer = accounts[0];

        // Convert price from ETH to Wei
        const priceInWei = web3.utils.toWei(priceInEth, "ether");

        // Call the purchaseNFT function
        await contract.methods.purchaseNFT(uniqId).send({
          from: buyer,
          value: priceInWei,
        });

        alert(`NFT with Unique ID: ${uniqId} purchased successfully!`);
      } catch (error) {
        console.error("Error purchasing NFT:", error);
        alert("Error purchasing NFT. Please check the console for details.");
      }
    }


    async function viewNFT() {
      document.getElementById("nftDetails").innerHTML = "";

      if (!web3) {
        alert("Please connect your wallet first.");
        return;
      }

      const uniqId = document.getElementById("uniqIdForView").value;
      if (!uniqId) {
        alert("Please enter a Unique ID.");
        return;
      }

      try {
        const accounts = await web3.eth.getAccounts();
        const userAddress = accounts[0];

        // Call the viewNFT function from the contract
        const nftData = await contract.methods.viewNFT(uniqId).call({ from: userAddress });

        console.log(nftData[2]);

        if (nftData[2] && nftData[2].length !== 0) {
          let html = '';
          for (let i = 0; i < nftData[2].length; i++) {
            const element = nftData[2][i];
            html += `<p>${i + 1}: ${element}</p>`;
          }

          document.getElementById("nftDetails").innerHTML = html;

        }
        else {
          document.getElementById("nftDetails").innerHTML = "You dont have access to this driver profile.";

        }


      } catch (error) {
        document.getElementById("nftDetails").innerHTML = error;
        console.error("Error viewing NFT:", error);
      }
    }
  </script>
  <app-root></app-root>
</body>

</html>
